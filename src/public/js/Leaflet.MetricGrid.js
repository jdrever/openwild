L.MetricGrid=L.Layer.extend({options:{proj4ProjDef:"must be provided",bounds:[[0,0],[0,0]],clip:null,latLonClipBounds:null,drawClip:!1,hundredKmSquareFunc:function(t,i){return""},showAxisLabels:[100,1e3,1e4],showAxis100km:!1,showSquareLabels:[],opacity:.7,weight:2,color:"#00f",font:"bold 16px Verdana",density:1,minInterval:100,maxInterval:1e5,minZoom:4},initialize:function(t){L.setOptions(this,t),this.options.fontColor||(this.options.fontColor=this.options.color)},onAdd:function(t){this._map=t,this._container||this._initCanvas(),t._panes.overlayPane.appendChild(this._container),t.on("viewreset",this._reset,this),t.on("move",this._reset,this),t.on("moveend",this._reset,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._container),t.off("viewreset",this._reset,this),t.off("move",this._reset,this),t.off("moveend",this._reset,this)},addTo:function(t){return t.addLayer(this),this},getAttribution:function(){return this.options.attribution},setOpacity:function(t){return this.options.opacity=t,this._updateOpacity(),this},bringToFront:function(){return this._canvas&&this._map._panes.overlayPane.appendChild(this._canvas),this},bringToBack:function(){var t=this._map._panes.overlayPane;return this._canvas&&t.insertBefore(this._canvas,t.firstChild),this},_initCanvas:function(){this._container=L.DomUtil.create("div","leaflet-image-layer"),this._canvas=L.DomUtil.create("canvas",""),this._updateOpacity(),this._container.appendChild(this._canvas),L.extend(this._canvas,{onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onCanvasLoad,this)})},_setClip:function(t){var i,o=this._map,n=this.options.proj4ProjDef;if(this.options.clip){var e,s,r,a,h,p,l,u;for(i=0;i<this.options.clip.length-1;i+=1){function f(t){return proj4(n).inverse([r+t*h,a+t*p])}for(e=this.options.clip[i+1][0],r=this.options.clip[i][0],s=this.options.clip[i+1][1],a=this.options.clip[i][1],h=e-r,p=s-a,l=this._getPoints(f,1,o),u=0,0==i&&(t.beginPath(),t.moveTo(l[0].x,l[0].y),u=1);u<l.length;u+=1)t.lineTo(l[u].x,l[u].y)}this.options.drawClip&&t.stroke(),t.clip()}},_setLLClipBounds:function(t,i){var o=L.latLngBounds(this.options.latLonClipBounds),n=i.latLngToContainerPoint(o.getSouthWest()),e=i.latLngToContainerPoint(o.getNorthEast());return t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(e.x,n.y),t.lineTo(e.x,e.y),t.lineTo(n.x,e.y),t.lineTo(n.x,n.y),this.options.drawClip&&t.stroke(),t.clip(),L.bounds(n,e)},_reset:function(){var t=this._container,i=this._canvas,o=this._map.getSize(),n=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(t,n),t.style.width=o.x+"px",t.style.height=o.y+"px",i.width=o.x,i.height=o.y,i.style.width=o.x+"px",i.style.height=o.y+"px",this._draw()},_onCanvasLoad:function(){this.fire("load")},_updateOpacity:function(){L.DomUtil.setOpacity(this._canvas,this.options.opacity)},_formatEastOrNorth(t,i){var o,n=Math.floor(t/1e5);if(t%=1e5,o=i<1e3?2==(o=1==(o=Math.floor(t/100).toString()).length?"0"+o:o).length?"0"+o:o:i<1e4?1==(o=Math.floor(t/1e3).toString()).length?"0"+o:o:Math.floor(t/1e4).toString(),this.options.showAxis100km){var e,s=n.toString();for(e=s.length-1;e>=0;e--)o=String.fromCharCode(s.charCodeAt(e)+8272)+o}return o},_format_eastings:function(t,i){return this._formatEastOrNorth(t,i)},_format_northings:function(t,i){return this._formatEastOrNorth(t,i)},_mPerPx:function(){var t=this._map.getCenter(),i=this._map.project(t).add(new L.Point(1,0)),o=this._map.unproject(i);return t.distanceTo(o)},_calcInterval:function(){var t,i=this._mPerPx();return t=i<=1?100:i<=20?1e3:i<=175?1e4:1e5,this.options.density&&(t/=this.options.density),t<this.options.minInterval&&(t=this.options.minInterval),t>this.options.maxInterval&&(t=this.options.maxInterval),t},_getPoints:function(t,i,o){for(var n,e,s,r,a,h,p=t(0),l=t(1),u=o.latLngToContainerPoint(L.latLng(p[1],p[0])),f=o.latLngToContainerPoint(L.latLng(l[1],l[0])),d=[],c=[l,p],m=[f,u],g=[1,0],_={},x=1e3;--x>0&&g.length>0;)s=g.pop(),p=c.pop(),u=m.pop(),_[h=s.toString()]||(d.push(u),_[h]=!0),r=g.pop(),l=c.pop(),f=m.pop(),n=t(a=(s+r)/2),e=o.latLngToContainerPoint(L.latLng(n[1],n[0])),L.LineUtil.pointToSegmentDistance(e,u,f)<i?(d.push(f),_[h=r.toString()]=!0):(g.push(r,a,a,s),m.push(f,e,e,u),c.push(l,n,n,p));return d},_inside:function(t,i){var o,n=t[0],e=t[1],s=!1;for(o=0,j=i.length-1;o<i.length;j=o++){var r=i[o][0],a=i[o][1],h=i[j][0],p=i[j][1];a>e!=p>e&&n<(h-r)*(e-a)/(p-a)+r&&(s=!s)}return s},_draw:function(){var t=this._canvas,i=this._map;if(L.Browser.canvas&&i){var o=i.getZoom();if(this.options.minZoom&&o<this.options.minZoom)return;if(this.options.maxZoom&&o>this.options.maxZoom)return;if(this.options.skipZoom&&this.options.skipZoom.indexOf(o)>-1)return;var n=this._calcInterval(),e=this.options.proj4ProjDef,s=t.getContext("2d");s.clearRect(0,0,t.width,t.height),s.lineWidth=this.options.weight,s.strokeStyle=this.options.color,s.fillStyle=this.options.fontColor,this.options.font&&(s.font=this.options.font);var r,a,h=s.measureText("0").width,p=s.font.split(" ");for(a=0;a<p.length&&(r=parseInt(p[a],10),isNaN(r));a+=1);var l=i.getBounds(),u=l.getSouthWest(),f=l.getNorthEast(),d=l.getNorthWest(),c=l.getSouthEast(),m=proj4(e).forward([u.lng,u.lat]),g=proj4(e).forward([f.lng,f.lat]),_=proj4(e).forward([d.lng,d.lat]),v=proj4(e).forward([c.lng,c.lat]),S=proj4(e).forward([l.getCenter().lng,l.getSouth()]),C=proj4(e).forward([l.getCenter().lng,l.getNorth()]),T=proj4(e).forward([l.getWest(),l.getCenter().lat]),b=proj4(e).forward([l.getEast(),l.getCenter().lat]),P=Math.min(m[0],_[0]),M=Math.max(v[0],g[0]),w=Math.min(m[1],v[1]),N=Math.max(_[1],g[1]);P=Math.min(T[0],P),M=Math.max(b[0],M),w=Math.min(S[1],w),N=Math.max(C[1],N),P=Math.floor(P/n)*n,w=Math.floor(w/n)*n,M=Math.ceil(M/n)*n,N=Math.ceil(N/n)*n;var j=null;if(this.options.clip){var O=this._inside([P,w],this.options.clip),G=this._inside([M,w],this.options.clip),B=this._inside([M,N],this.options.clip),H=this._inside([P,N],this.options.clip);O&&G&&B&&H||this._setClip(s)}else this.options.latLonClipBounds&&(j=this._setLLClipBounds(s,i));if(P<this.options.bounds[0][0]&&(P=Math.floor(this.options.bounds[0][0]/n)*n),P>this.options.bounds[1][0])return;if(M>this.options.bounds[1][0]&&(M=Math.ceil(this.options.bounds[1][0]/n)*n),M<this.options.bounds[0][0])return;if(w<this.options.bounds[0][1]&&(w=Math.floor(this.options.bounds[0][1]/n)*n),w>this.options.bounds[1][1])return;if(N>this.options.bounds[1][1]&&(N=Math.ceil(this.options.bounds[1][1]/n)*n),N<this.options.bounds[0][1])return;t.width;var A=t.height,D=n,F=D/2,U=N-w;for(x=P;x<=M;x+=D){function W(t){return proj4(e).inverse([x,N-t*U])}var k=this._getPoints(W,1,i);for(s.beginPath(),s.moveTo(k[0].x,k[0].y),a=1;a<k.length;a++)s.lineTo(k[a].x,k[a].y);s.stroke()}var R=M-P;for(y=w;y<=N;y+=D){function E(t){return proj4(e).inverse([M-t*R,y])}k=this._getPoints(E,1,i);for(s.beginPath(),s.moveTo(k[0].x,k[0].y),a=1;a<k.length;a++)s.lineTo(k[a].x,k[a].y);s.stroke()}s.fillStyle=this.options.color;var Z,J=3*this.options.weight;if(this.options.showAxisLabels.indexOf(D)>=0)for(x=P;x<=M;x+=D)for(y=w;y<=N;y+=D){var I=proj4(e).inverse([x,y+F]);if((Q=i.latLngToContainerPoint(L.latLng(I[1],I[0]))).x>0&&Q.y<A&&x<this.options.bounds[1][0]){if(this.options.clip){if(!this._inside([x,y+F],this.options.clip))continue}else if(this.options.latLonClipBounds&&!j.contains([Q.x,Q.y]))continue;var K=this._format_eastings(x,D);h=s.measureText(K).width,s.globalCompositeOperation="destination-out",s.fillRect(Q.x-J/2,Q.y-r,J,1.2*r),s.globalCompositeOperation="source-over",s.fillText(K,Q.x-h/2,Q.y);break}}if(this.options.showAxisLabels.indexOf(D)>=0)for(y=w;y<=N;y+=D)for(x=P;x<=M;x+=D){I=proj4(e).inverse([x+F,y]);if((Q=i.latLngToContainerPoint(L.latLng(I[1],I[0]))).x>0&&Q.y<A&&y<this.options.bounds[1][1]){if(this.options.clip){if(!this._inside([x+F,y],this.options.clip))continue}else if(this.options.latLonClipBounds&&!j.contains([Q.x,Q.y]))continue;var V=this._format_northings(y,D);h=s.measureText(V).width,s.globalCompositeOperation="destination-out",s.fillRect(Q.x-.1*h,Q.y-J/2,1.2*h,J),s.globalCompositeOperation="source-over",s.fillText(V,Q.x,Q.y+r/2);break}}if(this.options.showSquareLabels.indexOf(D)>=0)for(y=w;y<=N;y+=D)for(x=P;x<=M;x+=D){var Q;I=proj4(e).inverse([x,y]);if((Q=i.latLngToContainerPoint(L.latLng(I[1],I[0]))).x>0&&Q.y<A&&x<this.options.bounds[1][0]&&y<this.options.bounds[1][1]){V=this._format_northings(y,D),K=this._format_eastings(x,D);Z=this.options.hundredKmSquareFunc(x,y),D<1e5&&(Z+=K+V),s.fillText(Z,Q.x+2,Q.y-2)}}}}}),L.metricGrid=function(t){return new L.MetricGrid(t)},L.BritishGrid=L.MetricGrid.extend({options:{proj4ProjDef:"+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",bounds:[[0,0],[7e5,13e5]],clip:[[0,0],[7e5,0],[7e5,13e5],[0,13e5],[0,7e5],[1e5,65e4],[15e4,6e5],[19e4,55e4],[2e5,5e5],[2e5,4e5],[0,0]],hundredKmSquareFunc:function(t,i){var o=Math.floor(t/1e5),n=Math.floor(i/1e5);return o<7&&n<13&&o>=0&&n>=0?[["SV","SW","SX","SY","SZ","TV","TW"],["SQ","SR","SS","ST","SU","TQ","TR"],["SL","SM","SN","SO","SP","TL","TM"],["SF","SG","SH","SJ","SK","TF","TG"],["SA","SB","SC","SD","SE","TA","TB"],["SV","NW","NX","NY","NZ","OV","OW"],["NQ","NR","NS","NT","NU","OQ","OR"],["NL","NM","NN","NO","NP","OL","OM"],["NF","NG","NH","NJ","NK","OF","OG"],["NA","NB","NC","ND","NE","OA","OB"],["HV","HW","HX","HY","HZ","JV","JW"],["HQ","HR","HS","HT","HU","JQ","JR"],["HL","HM","HN","HO","HP","JL","JM"]][n][o]:"--"}}}),L.britishGrid=function(t){return new L.BritishGrid(t)},L.IrishGrid=L.MetricGrid.extend({options:{proj4ProjDef:"+proj=tmerc +lat_0=53.5 +lon_0=-8 +k=1.000035 +x_0=200000 +y_0=250000 +ellps=mod_airy +towgs84=482.5,-130.6,564.6,-1.042,-0.214,-0.631,8.15 +uni+units=m +no_defs",bounds:[[0,0],[5e5,5e5]],clip:[[0,0],[29e4,0],[37e4,3e5],[37e4,4e5],[31e4,46e4],[2e5,5e5],[0,5e5],[0,0]],hundredKmSquareFunc:function(t,i){var o=Math.floor(t/1e5),n=Math.floor(i/1e5);return o<5&&n<5&&o>=0&&n>=0?[["V","Q","L","F","A"],["W","R","M","G","B"],["X","S","N","H","C"],["Y","T","O","J","D"],["Z","U","P","K","E"]][o][n]:"--"}}}),L.irishGrid=function(t){return new L.IrishGrid(t)},L.UtmGrid=L.MetricGrid.extend({options:{bounds:[[1e5,0],[9e5,94e5]]},initialize:function(t,i,o){o.proj4ProjDef="+proj=utm +zone="+t+" +ellps=WGS84 +datum=WGS84 +units=m +no_defs",i&&(o.proj4ProjDef+=" +south",o.bounds=[[1e5,6e5],[9e5,1e7]]),o.hundredKmSquareFunc=function(o,n){var e="",s=["ABCDEFGHJKLMNPQRSTUV","FGHJKLMNPQRSTUVABCDE"],r=Math.floor(o/1e5),a=Math.floor(n/1e5),h=t-1;return i&&(a-=100),e=r>=1&&r<=8?["ABCDEFGH","JKLMNPQR","STUVWXYZ"][h%3].charAt(r-1):"-",e+=a>=0?s[h%2].charAt(a%20):s[h%2].charAt(19+(a+1)%20)},L.setOptions(this,o)}}),L.utmGrid=function(t,i,o){return new L.UtmGrid(t,i,o)};
